<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
            /* ⚠️ FIX: For a full-screen map, 100% height must be set for html and body */
            html, body {
                height: 100%; 
                padding: 0;
                margin: 0;
            }
            
            #map {
                width: 100%;
                height: 100%; 
                padding: 0;
                margin: 0;
            }
            
            /* STYLES FOR NAVIGATOR */
            .park-navigator {
                position: absolute;
                bottom: 10px; 
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000; 
                padding: 10px;
                background-color: rgba(255, 255, 255, 0.8);
                border-radius: 5px;
                font-family: sans-serif;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                pointer-events: auto; 
            }
            .park-navigator button {
                padding: 8px 15px;
                margin: 0 5px;
                cursor: pointer;
                border: 1px solid #ccc;
                border-radius: 3px;
                background-color: #f4f4f4;
            }
            #current-park-name {
                font-weight: bold;
                margin: 0 10px;
                vertical-align: middle;
                min-width: 50px;
                display: inline-block;
            }

            /* STYLES FOR LEGEND */
            .legend {
                padding: 10px;
                background-color: rgba(255, 255, 255, 0.8);
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-radius: 5px;
                line-height: 24px;
                color: #333;
                font-family: sans-serif;
            }
            .legend i {
                width: 18px;
                height: 18px;
                float: left;
                margin-right: 8px;
                opacity: 0.9;
                border-radius: 3px;
            }

            /* BLACK SEARCH ICON ON WHITE BACKGROUND */
            .leaflet-control-search .search-button {
                background-color: #ffffff !important; 
                color: #000000 !important; 
                background-image: none !important; 
                font-size: 16px; 
                line-height: 30px; 
            }

            /* PARK LABEL STYLING WITH SIMPLE BUFFER ZONE */
            .park-label {
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                font-weight: bold;
                font-size: 12px;
                color: #000;
                text-shadow: 2px 2px 3px white, -2px -2px 3px white, 2px -2px 3px white, -2px 2px 3px white;
                pointer-events: none;
                white-space: nowrap;
                padding: 5px !important;
            }
        </style>
        <title>NYC Parks Risk Factor Classification</title>
    </head>
    <body>
        <div id="map">
        </div>
        
        <div class="park-navigator">
            <button onclick="showPreviousPark()">&#9664; Previous</button>
            <span id="current-park-name"></span>
            <button onclick="showNextPark()">Next &#9654;</button>
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/ParksbyRiskFactor_1.js"></script>
        <script>
            
            // NAVIGATION LOGIC
            var currentIndex = 0;
            var parkFeatures = json_ParksbyRiskFactor_1.features; 
            var layer_ParksbyRiskFactor_1; 
            
            function displayCurrentPark() {
                if (parkFeatures.length === 0) return;

                var feature = parkFeatures[currentIndex];
                var parkName = feature.properties['Name'];
                
                var layer = layer_ParksbyRiskFactor_1 ? layer_ParksbyRiskFactor_1.getLayers().find(l => l.feature === feature) : null;
                
                document.getElementById('current-park-name').textContent = parkName;

                if (layer) {
                    if (typeof layer.getBounds === 'function') {
                        var bounds = layer.getBounds();
                        var mapSize = map.getSize();
                        var paddingX = mapSize.x * 0.25; 
                        var paddingY = mapSize.y * 0.25;

                        map.fitBounds(bounds, {
                            padding: [paddingX, paddingY],
                            duration: 0.5 
                        });
                    } else if (typeof layer.getLatLng === 'function') {
                        map.setView(layer.getLatLng(), 17, { duration: 0.5 }); 
                    } else {
                        map.setView(map.getCenter(), 14);
                    }
                }
            }

            function showPreviousPark() {
                currentIndex = (currentIndex - 1 + parkFeatures.length) % parkFeatures.length;
                displayCurrentPark();
            }

            function showNextPark() {
                currentIndex = (currentIndex + 1) % parkFeatures.length;
                displayCurrentPark();
            }

            var highlightLayer;
            function highlightFeature(e) {
                highlightLayer = e.target;
                if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
                    highlightLayer.setStyle({
                        color: 'rgba(255, 255, 0, 1.00)',
                    });
                } else {
                    highlightLayer.setStyle({
                        fillColor: 'rgba(255, 255, 0, 1.00)',
                        fillOpacity: 1
                    });
                }
            }

            var map = L.map('map', {
                zoomControl:false, maxZoom:28, minZoom:1
            })
            var hash = new L.Hash(map);
            map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
            var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

            // Hide park name when map moves/zooms
            map.on('movestart', function() {
                document.getElementById('current-park-name').textContent = '';
            });

            function removeEmptyRowsFromPopupContent(content, feature) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                var rows = tempDiv.querySelectorAll('tr');
                for (var i = 0; i < rows.length; i++) {
                    var td = rows[i].querySelector('td.visible-with-data');
                    var key = td ? td.id : '';
                    if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                        rows[i].parentNode.removeChild(rows[i]);
                    }
                }
                return tempDiv.innerHTML;
            }

            function addClassToPopupIfMedia(content, popup) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                var imgTd = tempDiv.querySelector('td img');
                if (imgTd) {
                    var src = imgTd.getAttribute('src');
                    if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                        popup._contentNode.classList.add('media');
                        setTimeout(function() { popup.update(); }, 10);
                    } else {
                        popup._contentNode.classList.remove('media');
                    }
                } else {
                    popup._contentNode.classList.remove('media');
                }
            }

            var title = new L.Control({'position':'topleft'});
            title.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };
            title.update = function () {
                this._div.innerHTML = '<h2>NYC Parks Risk Factor Classification</h2>';
            };
            title.addTo(map);

            var abstract = new L.Control({'position':'topright'});
            abstract.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'leaflet-control abstract');
                this._div.id = 'abstract';
                this._div.setAttribute("onmouseenter", "abstract.show()");
                this._div.setAttribute("onmouseleave", "abstract.hide()");
                this._div.classList.add("abstractUncollapsed"); 
                this.hide();
                return this._div;
            };
            abstract.hide = function () {
                this._div.classList.remove("abstractUncollapsed");
                this._div.classList.add("abstract");
                this._div.innerHTML = 'i';
            };
            abstract.show = function () {
                this._div.classList.remove("abstract");
                this._div.classList.add("abstractUncollapsed");
                this._div.innerHTML = 'The map categorizes and visualizes complex data related to air quality, traffic, heat vulnerability, asthma rates, and park features to inform decision-making and public awareness regarding park safety and quality.<br />Each park is represented by a color-coded marker based on a calculated Total Risk score, categorized into five levels (Dark Green: Low Risk, to Red: High Risk). Detailed risk factors, including fine particulate matter ($PM_{2.5}$), Black Carbon, traffic density, and estimated annual asthma emergency department visits, are available via clickable pop-up windows.<br /><br />© OpenStreetMap contributors. Data licensed under ODbL (Open Database Licence). Basemap tiles provided by RRZEOpenStreetMap HD. Risk Analysis Layer: NYC Parks by Risk Factors (Author: David Jindra; Client: Quantilus, represented by Debarshi Chaudhury)';
            };
            abstract.addTo(map);

            /* IMPLEMENTED LEGEND */
            var legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'legend'),
                    grades = [0, 25, 50, 75, 90],
                    labels = ['Low Risk', 'Minor Risk', 'Moderate Risk', 'Increased Risk', 'High Risk'],
                    colors = ['rgba(22,125,7,1.0)', 'rgba(132,187,15,1.0)', 'rgba(236,221,22,1.0)', 'rgba(239,103,10,1.0)', 'rgba(255,0,0,1.0)'];

                div.innerHTML = '<strong>Total Risk Level</strong><br>';
                for (var i = 0; i < grades.length; i++) {
                    div.innerHTML += '<i style="background:' + colors[i] + '"></i> ' + labels[i] + '<br>';
                }
                return div;
            };
            legend.addTo(map);

            var zoomControl = L.control.zoom({
                position: 'topleft'
            }).addTo(map);

            var bounds_group = new L.featureGroup([]);
            function setBounds() {
                if (bounds_group.getLayers().length) {
                    map.fitBounds(bounds_group.getBounds());
                }
            }

            map.createPane('pane_Basemap_0');
            map.getPane('pane_Basemap_0').style.zIndex = 400;
            var layer_Basemap_0 = L.tileLayer('http://a.osm.rrze.fau.de/osmhd/{z}/{x}/{y}.png', {
                pane: 'pane_Basemap_0',
                opacity: 0.6,
                attribution: '<a href="https://www.openstreetmap.org/copyright">© OpenStreetMap contributors, CC-BY-SA</a>',
                minZoom: 1,
                maxZoom: 28
            });
            map.addLayer(layer_Basemap_0);

            function pop_ParksbyRiskFactor_1(feature, layer) {
                layer.on({
                    mouseout: function(e) {
                        for (var i in e.target._eventParents) {
                            if (typeof e.target._eventParents[i].resetStyle === 'function') {
                                e.target._eventParents[i].resetStyle(e.target);
                            }
                        }
                    },
                    mouseover: highlightFeature,
                });

                // Lowercase for 'natural turf'
                var rawField = String(feature.properties['Sports Fie'] || "");
                var fieldType = rawField;
                if (rawField.toLowerCase().replace(/\s/g, '') === 'naturalturf') {
                    fieldType = 'natural turf';
                }

                // Add Label (Tooltip)
                layer.bindTooltip(feature.properties['Name'], {
                    permanent: true,
                    direction: 'center',
                    className: 'park-label'
                });

                var popupContent = '<table>\
                    <tr>\
                        <td colspan="2"><strong>Park name</strong><br />' + (feature.properties['Name'] !== null ? autolinker.link(String(feature.properties['Name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Type of field</th>\
                        <td class="visible-with-data" id="Sports Fie">' + (fieldType !== null ? autolinker.link(String(fieldType).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Risk factor</th>\
                        <td class="visible-with-data" id="Sports F_1">' + (feature.properties['Sports F_1'] !== null ? autolinker.link(String(feature.properties['Sports F_1']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Fine particles (PM 2.5)</th>\
                        <td class="visible-with-data" id="Sports F_2">' + (feature.properties['Sports F_2'] !== null ? autolinker.link(String(feature.properties['Sports F_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Black Carbon</th>\
                        <td class="visible-with-data" id="Sports F_3">' + (feature.properties['Sports F_3'] !== null ? autolinker.link(String(feature.properties['Sports F_3']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Nitric Oxide (NO)</th>\
                        <td class="visible-with-data" id="Sports F_4">' + (feature.properties['Sports F_4'] !== null ? autolinker.link(String(feature.properties['Sports F_4']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Nitrogen Dioxide (NO₂)</th>\
                        <td class="visible-with-data" id="Sports F_5">' + (feature.properties['Sports F_5'] !== null ? autolinker.link(String(feature.properties['Sports F_5']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Ozone (O₃)</th>\
                        <td class="visible-with-data" id="Sports F_6">' + (feature.properties['Sports F_6'] !== null ? autolinker.link(String(feature.properties['Sports F_6']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Sulfur Dioxide (SO₂)</th>\
                        <td class="visible-with-data" id="Sports F_7">' + (feature.properties['Sports F_7'] !== null ? autolinker.link(String(feature.properties['Sports F_7']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Asthma emergency department visits (age 5 to 17)</th>\
                        <td class="visible-with-data" id="Sports F_8">' + (feature.properties['Sports F_8'] !== null ? autolinker.link(String(feature.properties['Sports F_8']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Traffic Density</th>\
                        <td class="visible-with-data" id="Sports F_9">' + (feature.properties['Sports F_9'] !== null ? autolinker.link(String(feature.properties['Sports F_9']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tree canopy percent (vs. city overall)</th>\
                        <td class="visible-with-data" id="Sports F10">' + (feature.properties['Sports F10'] !== null ? autolinker.link(String(feature.properties['Sports F10']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tree canopy coverage (square kilometers)</th>\
                        <td class="visible-with-data" id="Sports F11">' + (feature.properties['Sports F11'] !== null ? autolinker.link(String(feature.properties['Sports F11']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Population per square kilometer</th>\
                        <td class="visible-with-data" id="Sports F12">' + (feature.properties['Sports F12'] !== null ? autolinker.link(String(feature.properties['Sports F12']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Heat vulnerability</th>\
                        <td class="visible-with-data" id="Sports F13">' + (feature.properties['Sports F13'] !== null ? autolinker.link(String(feature.properties['Sports F13']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Total Risk</th>\
                        <td class="visible-with-data" id="Sports F14">' + (feature.properties['Sports F14'] !== null ? autolinker.link(String(feature.properties['Sports F14']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
                var content = removeEmptyRowsFromPopupContent(popupContent, feature);
                layer.on('popupopen', function(e) {
                    addClassToPopupIfMedia(content, e.popup);
                });
                layer.bindPopup(content, { maxHeight: 400 });
            }

            function style_ParksbyRiskFactor_1_0(feature) {
                var val = feature.properties['Sports F14'];
                var style = { pane: 'pane_ParksbyRiskFactor_1', stroke: false, fill: true, fillOpacity: 1, interactive: true };
                if (val <= 25) style.fillColor = 'rgba(22,125,7,1.0)';
                else if (val <= 50) style.fillColor = 'rgba(132,187,15,1.0)';
                else if (val <= 75) style.fillColor = 'rgba(236,221,22,1.0)';
                else if (val <= 90) style.fillColor = 'rgba(239,103,10,1.0)';
                else style.fillColor = 'rgba(255,0,0,1.0)';
                return style;
            }

            map.createPane('pane_ParksbyRiskFactor_1');
            map.getPane('pane_ParksbyRiskFactor_1').style.zIndex = 401;
            
            layer_ParksbyRiskFactor_1 = new L.geoJson(json_ParksbyRiskFactor_1, { 
                pane: 'pane_ParksbyRiskFactor_1',
                onEachFeature: pop_ParksbyRiskFactor_1,
                style: style_ParksbyRiskFactor_1_0,
            });
            bounds_group.addLayer(layer_ParksbyRiskFactor_1);
            map.addLayer(layer_ParksbyRiskFactor_1);
            setBounds();

            map.addControl(new L.Control.Search({
                layer: layer_ParksbyRiskFactor_1,
                initial: false,
                hideMarkerOnCollapse: true,
                propertyName: 'Name'}));

            // Add FontAwesome search icon class to the search button
            document.querySelector('.leaflet-control-search .search-button').classList.add('fa', 'fa-search');

            // ZOOM-BASED LABEL VISIBILITY
            function checkLabelVisibility() {
                var z = map.getZoom();
                // ⬇️ MODIFICATION: Adjusted zoom range to include 1:2500 (Zoom 18) ⬇️
                if (z >= 15 && z <= 20) {
                    document.querySelectorAll('.leaflet-tooltip.park-label').forEach(function(label) {
                        label.style.display = 'block';
                    });
                } else {
                    document.querySelectorAll('.leaflet-tooltip.park-label').forEach(function(label) {
                        label.style.display = 'none';
                    });
                }
            }
            map.on('zoomend', checkLabelVisibility);
            
            layer_ParksbyRiskFactor_1.on('add', function() {
                setTimeout(checkLabelVisibility, 100);
            });

            setTimeout(displayCurrentPark, 500); 

        </script>        
    </body>
</html>